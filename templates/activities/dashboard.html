{% extends "activities/base.html" %}

{% block title %}Dashboard - Strava Stats{% endblock %}

{% block extra_css %}
<style>
    /* Cache bust: {{ "now"|date:"U" }} */
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <svg class="w-10 h-10 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                    </svg>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">Strava Stats</h1>
                        <p class="text-sm text-gray-500">Olá, {{ athlete_name }}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    {% if athlete_profile %}
                    <img src="{{ athlete_profile }}" alt="Profile" class="w-10 h-10 rounded-full">
                    {% endif %}
                    <a href="{% url 'activities:strava_logout' %}" 
                       class="text-gray-600 hover:text-gray-800 font-medium text-sm">
                        Sair
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Filters Section -->
        <section class="mb-8">
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                <div class="flex flex-wrap items-center gap-4">
                    <span class="text-sm font-medium text-gray-700">Filtros:</span>
                    <select id="sportFilter" onchange="applyFilters()" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Todos os esportes</option>
                            {% for sport in sport_types %}
                            <option value="{{ sport.value }}" {% if current_filters.sport == sport.value %}selected{% endif %}>{{ sport.label }}</option>
                            {% endfor %}
                        </select>
                        
                        <select id="monthFilter" onchange="applyFilters()" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Todos os meses</option>
                            {% for month in month_filters %}
                            <option value="{{ month.value }}" {% if current_filters.month == month.value|stringformat:'s' %}selected{% endif %}>{{ month.label }}</option>
                            {% endfor %}
                        </select>
                        
                        <select id="weekFilter" onchange="applyFilters()" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Todas as semanas</option>
                            {% for week in weekly_stats %}
                            <option value="{{ week.week_number }}" {% if current_filters.week == week.week_number|stringformat:'s' %}selected{% endif %}>{{ week.week }}</option>
                            {% endfor %}
                        </select>
                        
                        <input type="text" id="searchFilter" placeholder="Buscar atividades..." 
                               class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                               value="{{ current_filters.search }}" onkeyup="applyFilters()">
                    <button onclick="clearFilters()" class="px-3 py-2 text-sm text-orange-600 hover:text-orange-800 font-medium">
                        Limpar filtros
                    </button>
                </div>
            </div>
        </section>

        <!-- General Stats Cards -->
        <section class="mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Resumo do Ano</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <p class="text-sm text-gray-500 mb-1">Total de Atividades</p>
                    <p id="summaryActivities" class="text-2xl font-bold text-gray-800">{{ general_stats.total_activities }} / {{ total_general_stats.total_activities }}</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <p class="text-sm text-gray-500 mb-1">Tempo Total</p>
                    <p id="summaryTime" class="text-2xl font-bold text-gray-800">{{ general_stats.total_time }} / {{ total_general_stats.total_time }}</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <p class="text-sm text-gray-500 mb-1">Distância Total</p>
                    <p id="summaryDistance" class="text-2xl font-bold text-gray-800">{{ general_stats.total_distance }} / {{ total_general_stats.total_distance }} km</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <p class="text-sm text-gray-500 mb-1">Elevação Total</p>
                    <p id="summaryElevation" class="text-2xl font-bold text-gray-800">{{ general_stats.total_elevation }} / {{ total_general_stats.total_elevation }} m</p>
                </div>
            </div>
        </section>

        <!-- Additional Stats -->
        <section class="mb-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-sm p-6 text-white">
                    <p class="text-sm opacity-90 mb-1">Dias em Atividade</p>
                    <p class="text-2xl font-bold">{{ general_stats.activity_days }}</p>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-sm p-6 text-white">
                    <p class="text-sm opacity-90 mb-1">Melhor Dia</p>
                    <p class="text-2xl font-bold">{{ general_stats.best_week_day }}</p>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-sm p-6 text-white">
                    <p class="text-sm opacity-90 mb-1">Hora Mais Ativa</p>
                    <p class="text-2xl font-bold">{{ general_stats.best_active_hour }}</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-sm p-6 text-white">
                    <p class="text-sm opacity-90 mb-1">Tempo Médio</p>
                    <p class="text-2xl font-bold">{{ general_stats.avg_activity_time }}</p>
                </div>
            </div>
        </section>

        <!-- All Activities Table -->
        <section class="mt-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Atividades</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Esporte</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Distância</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Tempo</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Elevação</th>
                            </tr>
                        </thead>
                        <!-- Hidden table with all activities for filtering -->
<div style="display: none;">
    {% for activity in all_activities %}
    <tr class="hover:bg-gray-50 activity-row filter-data" data-sport="{{ activity.sport_type_key }}" data-name="{{ activity.name|lower }}" data-week="{{ activity.week }}" data-month="{{ activity.month }}" data-distance="{{ activity.distance_raw }}" data-time="{{ activity.elapsed_time_seconds }}" data-elevation="{{ activity.elevation_raw }}">
    </tr>
    {% endfor %}
</div>

<!-- Visible table with paginated activities -->
                        <tbody id="activitiesTableBody" class="divide-y divide-gray-100">
                            {% for activity in activities_page.activities %}
                            <tr class="hover:bg-gray-50 activity-row" data-sport="{{ activity.sport_type_key }}" data-name="{{ activity.name|lower }}" data-week="{{ activity.week }}" data-month="{{ activity.month }}" data-distance="{{ activity.distance_raw }}" data-time="{{ activity.elapsed_time_seconds }}" data-elevation="{{ activity.elevation_raw }}">
                                <td class="px-4 py-3 text-sm font-medium text-gray-800">{{ activity.name }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">{{ activity.sport_type }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">{{ activity.date }} {{ activity.time }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600 text-right">{{ activity.distance }} km</td>
                                <td class="px-4 py-3 text-sm text-gray-600 text-right">{{ activity.elapsed_time }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600 text-right">{{ activity.elevation }} m</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">Nenhuma atividade encontrada</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Pagination Controls -->
        {% if activities_page.total_pages > 1 %}
        <section class="mt-6">
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="text-sm text-gray-600">
                        Mostrando 
                        <span class="font-medium">{{ activities_page.activities|length }}</span> 
                        de 
                        <span class="font-medium">{{ activities_page.total_items }}</span> 
                        atividades
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-2">
                        <!-- Previous -->
                        {% if activities_page.has_previous %}
                        <a href="?page={{ activities_page.current_page|add:'-1' }}&per_page={{ activities_page.per_page }}{% if current_filters.sport %}&sport={{ current_filters.sport }}{% endif %}{% if current_filters.week %}&week={{ current_filters.week }}{% endif %}{% if current_filters.month %}&month={{ current_filters.month }}{% endif %}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}" 
                           class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            ← Anterior
                        </a>
                        {% else %}
                        <button disabled class="px-3 py-1 text-sm border border-gray-300 rounded opacity-50 cursor-not-allowed">
                            ← Anterior
                        </button>
                        {% endif %}
                        
                        <!-- Page Numbers -->
                        <div class="flex flex-wrap items-center gap-1">
                            <!-- Loop usando string como range -->
                            {% with ''|center:activities_page.total_pages as range %}
                            {% for _ in range %}
                                {% with forloop.counter as page_num %}
                                    {% if page_num == activities_page.current_page %}
                                    <span class="px-2 py-1 text-xs bg-orange-500 text-white rounded min-w-[2rem] text-center">{{ page_num }}</span>
                                    {% else %}
                                    <a href="?page={{ page_num }}&per_page={{ activities_page.per_page }}{% if current_filters.sport %}&sport={{ current_filters.sport }}{% endif %}{% if current_filters.week %}&week={{ current_filters.week }}{% endif %}{% if current_filters.month %}&month={{ current_filters.month }}{% endif %}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}" 
                                       class="px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 min-w-[2rem] text-center">
                                        {{ page_num }}
                                    </a>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                            {% endwith %}
                        </div>
                        
                        <!-- Next -->
                        {% if activities_page.has_next %}
                        <a href="?page={{ activities_page.current_page|add:'1' }}&per_page={{ activities_page.per_page }}{% if current_filters.sport %}&sport={{ current_filters.sport }}{% endif %}{% if current_filters.week %}&week={{ current_filters.week }}{% endif %}{% if current_filters.month %}&month={{ current_filters.month }}{% endif %}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}" 
                           class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">
                            Próximo →
                        </a>
                        {% else %}
                        <button disabled class="px-3 py-1 text-sm border border-gray-300 rounded opacity-50 cursor-not-allowed">
                            Próximo →
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- Per Page Selector -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Itens por página:</label>
                        <select onchange="changePerPage(this.value)" 
                                class="px-2 py-1 text-sm border border-gray-300 rounded">
                            <option value="25" {% if activities_page.per_page == 25 %}selected{% endif %}>25</option>
                            <option value="50" {% if activities_page.per_page == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if activities_page.per_page == 100 %}selected{% endif %}>100</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        <div class="grid md:grid-cols-2 gap-8 mt-12">
            <!-- Activity Types -->
            <section>
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Por Tipo de Atividade</h2>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Esporte</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Qtd</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Tempo</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Dist (km)</th>
                            </tr>
                        </thead>
                        <tbody id="activityTypeTableBody" class="divide-y divide-gray-100">
                            {% for stat in activity_type_stats %}
                            <tr class="hover:bg-gray-50 cursor-pointer activity-type-row" data-sport="{{ stat.sport_type_key }}" onclick="filterByType('{{ stat.sport_type_key }}')">
                                <td class="px-4 py-3 text-sm font-medium text-gray-800">{{ stat.sport_type }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600 text-right">{{ stat.count }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600 text-right">{{ stat.elapsed_time }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600 text-right">{{ stat.distance }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">Nenhuma atividade encontrada</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Activity Type Pie Chart -->
            <section>
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Distribuição por Tipo</h2>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="height: 350px;">
                    <canvas id="activityTypePieChart"></canvas>
                </div>
            </section>
        </div>


    </main>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ general_stats|json_script:"generalStats" }}
{{ activity_type_stats|json_script:"activityTypeStats" }}
<script>
// Obter dados do JSON script do Django
const generalStats = JSON.parse(document.getElementById('generalStats').textContent);
const activityTypeStats = JSON.parse(document.getElementById('activityTypeStats').textContent);

const totalStats = {
    activities: generalStats.total_activities || 0,
    distance: generalStats.total_distance_raw || 0,
    time: generalStats.total_time_seconds || 0,
    elevation: generalStats.total_elevation_raw || 0
};

const activityTypeData = activityTypeStats.map(stat => ({
    label: stat.sport_type || 'Desconhecido',
    count: stat.count || 0,
    color: stat.color || '#6B7280'
}));

const chartColors = [
    '#F97316', '#3B82F6', '#10B981', '#8B5CF6', '#EC4899', 
    '#F59E0B', '#06B6D4', '#84CC16', '#EF4444', '#6366F1'
];

let pieChart;

function initPieChart() {
    const canvas = document.getElementById('activityTypePieChart');
    if (!canvas) {
        console.error('Canvas activityTypePieChart not found');
        return;
    }
    const ctx = canvas.getContext('2d');
    const labels = activityTypeData.map(d => d.label);
    const data = activityTypeData.map(d => d.count);
    const colors = activityTypeData.map((_, i) => chartColors[i % chartColors.length]);
    
    pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 15,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function filterByType(sportType) {
    document.getElementById('sportFilter').value = sportType;
    applyFilters();
    document.getElementById('activitiesTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function filterByWeek(weekNumber) {
    document.getElementById('weekFilter').value = weekNumber;
    applyFilters();
    document.getElementById('activitiesTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function filterByMonth(monthNumber) {
    document.getElementById('monthFilter').value = monthNumber;
    applyFilters();
    document.getElementById('activitiesTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    }
    return `${minutes}m`;
}

function updatePieChart(sportCounts) {
    if (!pieChart) return;
    
    if (sportCounts === null) {
        // Restaurar dados originais
        pieChart.data.labels = activityTypeData.map(d => d.label);
        pieChart.data.datasets[0].data = activityTypeData.map(d => d.count);
    } else {
        // Usar dados filtrados
        const filteredLabels = [];
        const filteredData = [];
        const activityTypeRows = document.querySelectorAll('.activity-type-row');
        
        // Mapear os dados originais para encontrar as chaves corretas
        activityTypeRows.forEach(row => {
            const sport = row.dataset.sport;
            if (sportCounts[sport] > 0) {
                const cells = row.querySelectorAll('td');
                const label = cells[0].textContent;
                filteredLabels.push(label);
                filteredData.push(sportCounts[sport]);
            }
        });
        
        pieChart.data.labels = filteredLabels;
        pieChart.data.datasets[0].data = filteredData;
    }
    
    pieChart.update();
}

function applyFilters() {
    const sportFilter = document.getElementById('sportFilter').value;
    const weekFilter = document.getElementById('weekFilter').value;
    const monthFilter = document.getElementById('monthFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

    // Construir URL com filtros
    const currentUrl = new URL(window.location);
    
    // Limpar filtros antigos
    currentUrl.searchParams.delete('sport');
    currentUrl.searchParams.delete('week');
    currentUrl.searchParams.delete('month');
    currentUrl.searchParams.delete('search');
    
    // Adicionar filtros novos
    if (sportFilter) currentUrl.searchParams.set('sport', sportFilter);
    if (weekFilter) currentUrl.searchParams.set('week', weekFilter);
    if (monthFilter) currentUrl.searchParams.set('month', monthFilter);
    if (searchFilter) currentUrl.searchParams.set('search', searchFilter);
    
    // Resetar para primeira página
    currentUrl.searchParams.set('page', '1');
    
    // Recarregar página com filtros
    window.location.href = currentUrl.toString();
}

function clearFilters() {
    document.getElementById('sportFilter').value = '';
    document.getElementById('weekFilter').value = '';
    document.getElementById('monthFilter').value = '';
    document.getElementById('searchFilter').value = '';
    applyFilters();
}

function changePerPage(perPage) {
    // Preservar filtros atuais ao mudar itens por página
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('per_page', perPage);
    currentUrl.searchParams.set('page', '1'); // Resetar para primeira página
    window.location.href = currentUrl.toString();
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    console.log('totalStats:', totalStats);
    console.log('activityTypeData:', activityTypeData);
    initPieChart();
});
</script>
{% endblock %}
